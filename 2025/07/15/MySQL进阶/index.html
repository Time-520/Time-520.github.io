<!-- build time:Tue Aug 05 2025 17:08:25 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="字节纪元" href="https://time-520.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="字节纪元" href="https://time-520.github.io/atom.xml"><link rel="alternate" type="application/json" title="字节纪元" href="https://time-520.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://time-520.github.io/2025/07/15/MySQL%E8%BF%9B%E9%98%B6/"><title>MySQL进阶 | ByteChronicle = 字节纪元</title><meta name="generator" content="Hexo 5.4.2"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">MySQL进阶</h1><div class="meta"><span class="item" title="Created: 2025-07-15 10:13:01"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2025-07-15T10:13:01+08:00">2025-07-15</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">ByteChronicle</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://www.dmoe.cc/random.php?729613"></li><li class="item" data-background-image="https://www.dmoe.cc/random.php?946032"></li><li class="item" data-background-image="https://www.dmoe.cc/random.php?798435"></li><li class="item" data-background-image="https://www.dmoe.cc/random.php?690665"></li><li class="item" data-background-image="https://www.dmoe.cc/random.php?320205"></li><li class="item" data-background-image="https://www.dmoe.cc/random.php?580702"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://time-520.github.io/2025/07/15/MySQL%E8%BF%9B%E9%98%B6/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Years Pass"><meta itemprop="description" content=", 字节 + 编年史，记录开发旅程与项目成长。"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="字节纪元"></span><div class="body md" itemprop="articleBody"><h1 id="存储引擎"><a class="anchor" href="#存储引擎">#</a> 存储引擎</h1><h2 id="mysql体系结构"><a class="anchor" href="#mysql体系结构">#</a> mysql 体系结构</h2><p><img data-src="/picture/mysqltixijiegou.png" alt="图片"></p><ul><li>连接层<br>最上层是一些客户端和链接服务，主要完成一些类似于连接处理、授权认证、及相关的安全方案。服务器也会为安全接入的每个客户<br>端验证它所具有的操作权限。</li><li>服务层<br>第二层架构主要完成大多数的核心服务功能，如 SQL 接口，并完成缓存的查询，SQL 的分析和优化，部分内置函数的执行。所有跨存<br>储引擎的功能也在这一层实现，如过程、函数等。</li><li>引擎层<br>存储引擎真正的负责了 MySQL 中数据的存储和提取，服务器通过 API 和存储引擎进行通信。不同的存储引擎具有不同的功能，这样我<br>们可以根据自己的需要，来选取合适的存储引擎。</li><li>存储层<br>主要是将数据存储在文件系统之上，并完成与存储引擎的交互。</li></ul><h2 id="存储引擎简介"><a class="anchor" href="#存储引擎简介">#</a> 存储引擎简介</h2><p>存储引擎就是存储数据 建立索引 更新 / 查询数据等技术的实现方式 存储引擎是基于表 而不是基于库的 所以存储引擎也可以被称为标类型</p><ol><li>在创建表时 指定存储引擎</li></ol><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">table</span> 表名</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    字段<span class="token number">1</span> 字段<span class="token number">1</span>类型</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span>存储引擎<span class="token punctuation">;</span></pre></td></tr></table></figure><ol start="2"><li>查看当前数据库支持的存储引擎<br><code>show engines;</code></li></ol><h2 id="存储引擎特点"><a class="anchor" href="#存储引擎特点">#</a> 存储引擎特点</h2><h3 id="innodb"><a class="anchor" href="#innodb">#</a> InnoDB</h3><p>InnoDB 是一种兼顾高可靠性和高性能的通用存储引擎 在 mysql5.5 之后 InnoDB 是默认的 mysql 存储引擎</p><ul><li><p>特点<br>DML 操作遵循 ACID 模型 支持事务<br>行级锁 提高并发访问性能<br>支持外键 foreign key 约束 保证数据的完整性和正确性</p></li><li><p>文件<br>xxx -ibd：xxx 代表的是表名，innoDB 引擎的每张表都会对应这样一个表空间文件，存储该表的表结构 (frm、sdi)、数据和索引。<br>参数：innodb_file_per_table</p></li><li><p>逻辑存储结构<br><img data-src="/picture/QQ20250715-185017.png" alt="图片"></p></li></ul><h3 id="myisam"><a class="anchor" href="#myisam">#</a> MyISAM</h3><ul><li>介绍：myisam 是 mysql 早期的默认存储引擎</li><li>特点：<br>不支持事务 不支持外键<br>支持表锁 不支持持行锁<br>访问速度快</li><li>文件<br>xXX.sdi：存储表结构信息<br>XXX.MYD: 存储数据<br>XXX.MYI: 存储索引</li></ul><h3 id="memory"><a class="anchor" href="#memory">#</a> Memory</h3><ul><li>介绍<br>Memory 引擎的表数据时存储在内存中的，由于受到硬件问题、或断电问题的影响，只能将这些表作为临时表或缓存使用。</li><li>特点<br>内存存放<br>hash 索引（默认）</li><li>文件<br>xxx.sdi: 存储表结构信息</li></ul><h3 id="特点表"><a class="anchor" href="#特点表">#</a> 特点表</h3><table><thead><tr><th style="text-align:left">特点</th><th style="text-align:left">InnoDB</th><th style="text-align:left">MyISAM</th><th style="text-align:left">Memory</th></tr></thead><tbody><tr><td style="text-align:left">存储限制</td><td style="text-align:left">64TB</td><td style="text-align:left">有</td><td style="text-align:left">有</td></tr><tr><td style="text-align:left">事务安全</td><td style="text-align:left">支持</td><td style="text-align:left">-</td><td style="text-align:left">-</td></tr><tr><td style="text-align:left">锁机制</td><td style="text-align:left">行锁</td><td style="text-align:left">表锁</td><td style="text-align:left">表锁</td></tr><tr><td style="text-align:left">B+tree 索引</td><td style="text-align:left">支持</td><td style="text-align:left">支持</td><td style="text-align:left">支持</td></tr><tr><td style="text-align:left">hash 索引</td><td style="text-align:left">-</td><td style="text-align:left">-</td><td style="text-align:left">支持</td></tr><tr><td style="text-align:left">全文索引</td><td style="text-align:left">支持 (5.6 版本之后)</td><td style="text-align:left">支持</td><td style="text-align:left">-</td></tr><tr><td style="text-align:left">空间使用</td><td style="text-align:left">高</td><td style="text-align:left">低</td><td style="text-align:left">N/A</td></tr><tr><td style="text-align:left">内存使用</td><td style="text-align:left">高</td><td style="text-align:left">低</td><td style="text-align:left">中等</td></tr><tr><td style="text-align:left">批量插入速度</td><td style="text-align:left">低</td><td style="text-align:left">高</td><td style="text-align:left">高</td></tr><tr><td style="text-align:left">支持外键</td><td style="text-align:left">支持</td><td style="text-align:left">-</td><td style="text-align:left">-</td></tr></tbody></table><h2 id="存储引擎选择"><a class="anchor" href="#存储引擎选择">#</a> 存储引擎选择</h2><p>在选择存储引擎时，应该根据应用系统的特点选择合适的存储引擎。对于复杂的应用系统，还可以根据实际情况选择多种存储引擎进行组合</p><ul><li>InnoDB：是 Mysql 的默认存储引擎，支持事务、外键。如果应用对事务的完整性有比较高的要求，在并发条件下要求数据的一致<br>栓，数据操作除了插入和查询之外，还包含很多的更新、删除操作，那么 InnoDB 存储引擎是比较合适的选择</li><li>MyISAM：如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不是很高，那<br>么选择这个存储引擎是非常合适的</li><li>MEMORY：将所有数据保存在内存中，访问速度快，通常用于临时表及缓存。MEMORY 的缺陷就是对表的大小有限制，太大的表<br>无法缓存在内存中，而且无法保障数据的安全性</li></ul><h1 id="索引"><a class="anchor" href="#索引">#</a> 索引</h1><h2 id="索引概述"><a class="anchor" href="#索引概述">#</a> 索引概述</h2><ul><li>介绍：索引（index）是帮助 MySQL 高效获取数据的数据结构（有序）。在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些<br>数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引</li></ul><table><thead><tr><th>优势</th><th>劣势</th></tr></thead><tbody><tr><td>提高数据检索的效率 降低数据库的 IO 成本</td><td>索引列也是要占用空间的</td></tr><tr><td>通过索引列对数据进行排序 降低数据排序的成本 减低 cpu 的消耗</td><td>索引大大提高了查询效率 同时却也降低更新表的速度 如对表进行 insert update delete 时 效率降低</td></tr></tbody></table><h2 id="索引结构"><a class="anchor" href="#索引结构">#</a> 索引结构</h2><h3 id="介绍"><a class="anchor" href="#介绍">#</a> 介绍</h3><p>mysql 的索引是在存储引擎层实现的 不同的存储引擎有不同的结构 主要包含一下几种：</p><table><thead><tr><th style="text-align:left">索引结构</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td style="text-align:left">B+Tree</td><td style="text-align:left">最常见的索引类型 大部分引擎都支持 B + 数索引</td></tr><tr><td style="text-align:left">Hash 索引</td><td style="text-align:left">底层数据结构是用哈希表现的 只有精神匹配索引列的查询才有效 不支持范围查询</td></tr><tr><td style="text-align:left">R-tree (空间索引)</td><td style="text-align:left">空间索引是 mysql 引擎的一个特殊索引类型 主要用于地理空间数据类型 通常使用较少</td></tr><tr><td style="text-align:left">Full-text (全文索引)</td><td style="text-align:left">是一种通过建立倒排索引 快速匹配文档的方式 类似 Lucene Solr Es</td></tr></tbody></table><table><thead><tr><th style="text-align:left">索引</th><th style="text-align:left">InnoDB</th><th style="text-align:left">MyISAM</th><th style="text-align:left">Memory</th></tr></thead><tbody><tr><td style="text-align:left">B+tree</td><td style="text-align:left">支持</td><td style="text-align:left">支持</td><td style="text-align:left">支持</td></tr><tr><td style="text-align:left">Hash 索引</td><td style="text-align:left">不支持</td><td style="text-align:left">不支持</td><td style="text-align:left">支持</td></tr><tr><td style="text-align:left">R-tree</td><td style="text-align:left">不支持</td><td style="text-align:left">支持</td><td style="text-align:left">不支持</td></tr><tr><td style="text-align:left">Full-text</td><td style="text-align:left">5.6 版本之后支持</td><td style="text-align:left">支持</td><td style="text-align:left">不支持</td></tr></tbody></table><p>我们平常所说的索引，如果没有特别指明，都是指 B + 树结构组织的索引</p><h3 id="btree"><a class="anchor" href="#btree">#</a> Btree</h3><ul><li>Btree (多路平衡查找树)<br>以一颗最大度数为 5（5 阶）的 b+tree 为例（每个节点最多存储 4 个 key 5 个指针 ）<br><img data-src="/picture/QQ20250716-161609.png" alt="图片"></li><li>具体动态变化的过程可以参考网站:<span class="exturl" data-url="aHR0cHM6Ly93d3cuY3MudXNmY2EuZWR1L35nYWxsZXMvdmlzdWFsaXphdGlvbi9CVHJlZS5odG1s">https://www.cs.usfca.edu/~galles/visualization/BTree.html</span></li></ul><h3 id="btree索引"><a class="anchor" href="#btree索引">#</a> B+tree 索引</h3><p>相对于 Btree 区别：</p><ol><li>所有的数据都会出现在叶子节点</li><li>叶子节点形成一个单向链表</li></ol><ul><li>MySQL 索引数据结构对经典的 B+Tree 进行了优化。在原 B+Tree 的基础上，增加一个指向相邻叶子节点的链表指针，就形成了带有顺序<br>指针的 B+Tree，提高区间访问的性能</li><li>示例图：<br><img data-src="/picture/QQ20250716-165000.png" alt="图片"></li></ul><h3 id="hash索引"><a class="anchor" href="#hash索引">#</a> Hash 索引</h3><ul><li>Hash<br>哈希索引就是采用一定的 hash 算法，将键值换算成新的 hash 值，映射到对应的槽位上，然后存储在 hash 表中</li><li>如果两个 (或多个) 键值，映射到一个相同的槽位上，他们就产生了 hash 冲突（也称为 hash 碰撞），可以通过链表来解决</li><li>hash 索引特点</li></ul><ol><li>hash 索引只能用于对等比较 (=,in), 不支持范围查询 (between,&gt;,&lt;,…)</li><li>无法利用索引完成排序操作</li><li>查询效率高 通常只需要一次检索就可以了 效率通常高于 b+tree 索引（不出现哈希碰撞）</li></ol><ul><li>存储引擎 支持<br>在 MySQL 中，支持 hash 索引的是 Memory 引擎，而 InnoDB 中具有自适应 hash 功能，hash 索引是存储引擎根据 B+Tree 索引在指定条件下自动构<br>建的</li></ul><h2 id="索引分类"><a class="anchor" href="#索引分类">#</a> 索引分类</h2><table><thead><tr><th style="text-align:center">分类</th><th style="text-align:center">含义</th><th style="text-align:center">特点</th><th style="text-align:center">关键字</th></tr></thead><tbody><tr><td style="text-align:center">主键唯一</td><td style="text-align:center">针对于表中主键创建的索引</td><td style="text-align:center">默认自动创建 只能有一个</td><td style="text-align:center">primary</td></tr><tr><td style="text-align:center">唯一索引</td><td style="text-align:center">避免同一个表中某个数据列中的值重复</td><td style="text-align:center">可以有多个</td><td style="text-align:center">unique</td></tr><tr><td style="text-align:center">常规索引</td><td style="text-align:center">快速定位特定数据</td><td style="text-align:center">可以有多个</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center">全文索引</td><td style="text-align:center">全文索引查找的时文本中的关键词 而不是比较索引中的值</td><td style="text-align:center">可以有多个</td><td style="text-align:center">fulltext</td></tr></tbody></table><p>在 InnoDB 存储引擎中，根据索引的存储形式，又可以分为以下两种：</p><table><thead><tr><th style="text-align:center">分类</th><th style="text-align:center">含义</th><th style="text-align:center">特点</th></tr></thead><tbody><tr><td style="text-align:center">聚集索引</td><td style="text-align:center">将数据存储与索引放到了一块 索引结构的叶子节点保存了行数据</td><td style="text-align:center">必须有而且只有一个</td></tr><tr><td style="text-align:center">二级索引</td><td style="text-align:center">将数据与索引分开存储 索引结构的叶子节点关联的是对应的主键</td><td style="text-align:center">可以存储多个</td></tr></tbody></table><ul><li>聚集索引选取规则：<br>如果存在主键，主键索引就是聚集索引<br>如果不存在主键，将使用第一个唯一 (UNIQUE）索引 I 作为聚集索引<br>如果表没有主键，或没有合适的唯一索引，则 InnoDB 会自动生成一个 <code>rowid</code> 作为隐藏的聚集索引</li><li>回表查询：<br><img data-src="/picture/QQ20250717-162019.png" alt="图片"></li></ul><h2 id="索引语法"><a class="anchor" href="#索引语法">#</a> 索引语法</h2><ul><li>创建索引<br><code>create index 索引名 on 表名(表中字段名,（一个索引可以连接多个字段称为 联合索引）);</code></li><li>查看索引<br><code>show index from 表名;</code></li><li>删除索引<br><code>drop index 索引名 on 表名;</code></li></ul><h2 id="sql性能分析"><a class="anchor" href="#sql性能分析">#</a> SQL 性能分析</h2><h3 id="sql执行频率"><a class="anchor" href="#sql执行频率">#</a> sql 执行频率</h3><p>MySQL 客户端连接成功后，通过 show <code>[session|global]</code> status 命令可以提供服务器状态信息。通过如下指令，可以查看当前数据库的<br>INSERT、UPDATE、DELETE、SELECT 的访问频次:<br><code>show global statuslike 'com_______';</code></p><h3 id="慢查询日志"><a class="anchor" href="#慢查询日志">#</a> 慢查询日志</h3><ul><li>查看命令<br><code>show variables like 'slow_query_log';</code><br>慢查询日志记录了所有执行时间超过指定参数 (long_query_time，单位：秒，默认 10 秒）的所有 sQL 语句的日志<br>MySQL 的慢查询日志默认没有开启，需要在 MySQL 的配置文件（/etc/my.cnf）中配置如下信息：</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 开启 mysql 慢日志查询开关</span></pre></td></tr><tr><td data-num="2"></td><td><pre>show_query_log<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 设置慢日志的时间为 2 秒 sql 语句执行时间超过 2 秒 就会视为慢查询 记录慢查询日志</span></pre></td></tr><tr><td data-num="4"></td><td><pre>long_query_time<span class="token operator">=</span><span class="token number">2</span></pre></td></tr></table></figure><p>配置完毕之后，通过以下指令重新启动 MySQL 服务器选行测试，查看慢日志文件中记录的信息 /var/lib/mysql/localhost-slow.log</p><h3 id="profile"><a class="anchor" href="#profile">#</a> profile</h3><p>show profiles 能够在做 SQL 优化时帮助我们了解时间都耗费到哪里去了 通过 have_profiling 参数，能够看到当前 MySQL 是否支持<br>profile 操作：<br><code>select @@have_profiling</code><br>默认 profiling 是关闭的，可以通过 set 语句在 session/global 级别开启 profiling：<br><code>set profiling =1;</code><br>执行一系列的业务 sql 的操作 然后通过如下指令的执行耗时：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 查看每一条 sql 的耗时基本情况</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">show</span> profiles<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 查看指定 query_id 的 sql 语句各个阶段的耗时情况</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">show</span> profile <span class="token keyword">for</span> query query_id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">-- 查看指定 query_id 的 sql 语句 cpu 的使用情况</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">show</span> profile cpu <span class="token keyword">for</span> query query_id<span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="explain执行计划"><a class="anchor" href="#explain执行计划">#</a> explain 执行计划</h3><p>EXPLAIN 或者 DESC 命令获取 MySQL 如何执行 SELECT 语句的信息，包括在 SELECT 语句执行过程中表如何连接和连接的顺序。<br>语法：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- select 语句之前加上关键字 explain/desc</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> 字段列表 <span class="token keyword">FROM</span> 表名  <span class="token keyword">WHERE</span> 条件<span class="token punctuation">;</span></pre></td></tr></table></figure><p>EXPLAIN 执行计划各字段含义：</p><ul><li>id<br>select 查询的序列号，表示查询中执行 select 子句或者是操作表的顺序 (id 相同 执行顺序从上到下；id 不同，值越大，越先执行)</li><li>select_type<br>表示 SELECT 的类型，常见的取值有 SIMPLE（简单表，即不使用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、<br>UNION (UNION 中的第二个或者后面的查询语句）、SUBQUERY（SELECT/WHERE 之后包含了子查询）等</li><li>type<br>表示连接类型，性能由好到差的连接类型为 NULL、system、const、eq_ref、ref、range、index、all</li><li>possible_key<br>显示可能应用在这张表上的索引，一个或多个</li><li>key<br>实际使用的索引，如果为 NULL，则没有使用索引</li><li>key_len<br>表示索引中使用的字节数，该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下，长度越短越好</li><li>rows<br>MySQL 认为必须要执行查询的行数，在 innod6 引擎的表中，是一个估计值，可能并不总是准确的</li><li>filtered<br>表示返回结果的行数占需读取行数的百分比，filtered 的值越大越好</li></ul><h2 id="索引使用"><a class="anchor" href="#索引使用">#</a> 索引使用</h2><ul><li><p>验证索引效率<br>在未建立索引之前 执行如下 sql 语句 查看 sql 的耗时<br><code>select * from 表名 where 条件;</code><br>针对字段创建索引<br><code>create index 索引名 on 表名(字段名);</code><br>然后再次执行相同的 sql 语句 再次查看 sql 的耗时<br><code>select * from 表名 where 条件;</code></p></li><li><p>最左前缀法则<br>如果索引了多列（联合索引），要遵守最左前缀法则。最左前缀法则指的是查询从索引的最左列开始，并且不跳过索引中的列<br>如果跳跃某一列， <code>索引将部分失效（后面的字段索引失效）</code></p></li><li><p>范围查询<br>联合索引中，出现范围查询（&gt;,&lt;) 范围查询右侧的列索引失效</p></li><li><p>索引列运算<br>不要在索引列上进行（函数）运算操作 索引将失效</p></li><li><p>字符串不加单引号<br>字符串类型字段使用时 不加单引号 索引将失效 <code>不加单引号存在字符类型转换</code></p></li><li><p>模糊查询（like 占位符）<br>如果仅仅是尾部模糊匹配 索引不会失效 如果是头部模糊匹配 索引失效</p></li><li><p>or 连接的条件<br>用 or 分隔开的条件 如果 or 前的条件中的列有索引 而后面的列中没有索引 那么涉及的索引都不会被用到</p></li><li><p>数据分布影响<br>如果 mysql 评估使用索引比全表更慢 则不使用索引</p></li><li><p>sql 提示<br>sql 提示 是优化数据库的一个重要手段 简单来说 就是在 sql 语句中加入一些人为的提示来达到优化操作的目的<br>use index（使用索引）、ignore index（忽略索引）、force index（必须）<br><code>explain select * from 表名 use index/igonre index/force 指定索引名字 index() where条件</code></p></li><li><p>覆盖索引<br>尽量使用覆盖索引（查询使用了索引 并且需要返回的列 在该索引中已经全部能够找到）减少 select *<br>知识小贴士：<br>using index condition：查找使用了索引 但是需要回标查询数据<br>using where;using index: 查找使用了索引 但是需要的数据都在索引列中找到 所有不需要会标查询数据</p></li><li><p>前缀索引<br>当字段类型为字符串 (varchar，text 等）时，有时候需要索引很长的字符串，这会让索引变得很大，查询时，浪费大量的磁盘 IO 影响查<br>询效率。此时可以只将字符串的一部分前缀，建立索引，这样可以大大节约索引空间，从而提高索引效率</p></li><li><p>语法：<br><code>create index 索引名称 on 表名(字段名(n个))</code></p></li><li><p>前缀长度<br>可以根据索引的选择性来决定，而选择性是指不重复的索引值（基数）和数据表的记录总数的比值，索引选择性越高则查询效率越高，<br>唯一索引的选择性是 1，这是最好的索引选译性，性能也是最好的。</p></li><li><p>单列索引与联合索引<br>单列索引：即一个索引只包含单个列<br>联合索引：即一个索引只包含多个列<br>在业务场景中，如果存在多个查询条件，考虑针对于查询字段建立索引时，建议建立联合索引，而非单列索引</p></li><li><p>多条件联合查询时，MySQL 优化器会评估哪个字段的索引效率更高，会选择该索引完成本次查询</p></li></ul><h2 id="索引设计原则"><a class="anchor" href="#索引设计原则">#</a> 索引设计原则</h2><ol><li>针对于数据量较大，且查询比较频繁的表建立索引</li><li>针对于常作为查询条件 (where)、排序 (order by)、分组 (group by) 操作的字段建立索引</li><li>尽量选择区分度高的列作为索引，尽量建立唯一索引，区分度越高，使用索引的效率越高</li><li>如果是字符串类型的字段，字段的长度较长，可以针对于字段的特点，建立前缀索引</li><li>尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高查询效率</li><li>要控制索引的数量，索引并不是多多益善，索引越多，维护索引结构的代价也就越大，会影响增删改的效率</li><li>如果索引列不能存储 NULL 值，请在创建表时使用 NOTNULL 约束它。当优化器知道每列是否包含 NULL 值时它可以更好地确定哪个<br>索引最有效地用于查询</li></ol><h1 id="sql优化"><a class="anchor" href="#sql优化">#</a> SQL 优化</h1><h2 id="插入数据"><a class="anchor" href="#插入数据">#</a> 插入数据</h2><h3 id="insert优化"><a class="anchor" href="#insert优化">#</a> insert 优化</h3><p>批量插入 手动提交事务 主键顺序插入（主键顺序插入性能高于乱序插入）</p><ul><li>大批量插入数据<br>如果一次性需要插入大批量数据，使用 insert 语句插入性能较低，此时可以使用 MysQL 数据库提供的 load 指令进行插入。操作如下：</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 客户端连接服务端是 加上参数 --local-infile</span></pre></td></tr><tr><td data-num="2"></td><td><pre>mysql <span class="token comment">--local-infile -u root -p</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">-- 设置全局参数 local_infile 为 1 开启从本地加载文件导入数据的开关</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">set</span> <span class="token keyword">global</span> local_infile<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">-- 执行 load 指令将准备好的数据 加载到表结构中</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> <span class="token keyword">infile</span> <span class="token string">'/root/文件名'</span><span class="token keyword">into</span> <span class="token keyword">table</span> <span class="token string">'表名'</span> <span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span><span class="token keyword">lines</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\n'</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>主键顺序插入性能高于乱序插入</p><h2 id="主键优化"><a class="anchor" href="#主键优化">#</a> 主键优化</h2><ul><li>数据组织方式<br>在 InnoDB 存储引擎中，表数据都是根据主键顺序组织存放的，这种存储方式的表称为索引组织表 (index organized table IOT)</li><li>页分裂<br>页可以为空，也可以填充一半，也可以填充 100%。每个页包含了 2-N 行数据 (如果一行数据多大，会行溢出)，根据主键排列</li><li>页合并<br>当删除一行记录时，实际上记录并没有被物理删除，只是记录被标记 (flaged）为删除并且它的空间变得允许被其他记录声明使用。<br>当页中删除的记录达到 MERGE_THRESHOLD（默认为页的 50%），InnODB 会开始寻找最靠近的页（前或后）看看是否可以将两个页合并以优<br>化空间使用</li><li>知识小贴士：<br>MERGE_THRESHOLD：合并页的阈值，可以自己设置，在创建表或者创建索引 I 时指定</li><li>主键设计原则</li></ul><ol><li>满足业务需求的情况下 尽量降低主键的长度</li><li>插入数据时 尽量选择顺序插入 选择使用 auto_increment 自增主键</li><li>尽量不要使用 UUID 做主键或者是其他自然主键，如身份证号</li><li>业务操作时，避免对主键的修改</li></ol><h2 id="order-by优化"><a class="anchor" href="#order-by优化">#</a> order by 优化</h2><ol><li>Using filesort：通过表的索引或全表扫描，读取满足条件的数据行，然后在排序缓冲区 sort buffer 中完成排序操作，所有不是通过索引直<br>接返回排序结果的排序都叫 FileSort 排序。</li><li>Using index：通过有序索引顺序扫描直接返回有序数据，这种情况即为 using index，不需要额外排序，操作效率高。</li></ol><ul><li>根据排序字段建立合适的索引，多字段排序时，也遵循最左前缀法则</li><li>尽量使用覆盖索引</li><li>多字段排序，一个升序一个降序，此时需要注意联合索引在创建时的规则（ASC/DESC)</li><li>如果不可避免的出现 filesort，大数据量排序时，可以适当增大排序缓冲区大小 sort_buffer_size (默认 256k）</li></ul><h2 id="group-by优化"><a class="anchor" href="#group-by优化">#</a> group by 优化</h2><p>在分组操作时，可以通过索引来提高效率。<br>分组操作时，索引的使用也是满足最左前缀法则的</p><h2 id="limit优化"><a class="anchor" href="#limit优化">#</a> limit 优化</h2><p>一个常见又非常头疼的问题就是 limit2000000,10，此时需要 MySQL 排序前 2000010 记录，仅仅返回 2000000-2000010<br>的记录，其他记录丢弃，查询排序的代价非常大<br>优化思路：一般分页查询时，通过创建覆盖索引能够比较好地提高性能，可以通过覆盖索引加子查询形式进行优化<br><code>explain select * from tb_sku t, (select id from tb_sku order by id limit 2oooooo,10) a where t.id = a.id;</code></p><h2 id="count优化"><a class="anchor" href="#count优化">#</a> count 优化</h2><p>MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行 cOunt (*) 的时候会直接返回这个数，效率很高<br>InnoDB 引擎就麻烦了，它执行 <code>count(*)</code> 的时候，需要把数据一行一行地从引擎里面读出来，然后累积计数<br>优化思路：自己计数</p><ul><li>count 的几种用法<br>count () 是一个聚合函数，对于返回的结果集，一行行地判断，如果 count 函数的参数不是 NULL，累计值就加 1，否则不加，最后<br>返回累计值</li><li>用法：<br>count(*)<br>InnoDB 引擎并不会把全部字段取出来，而是专门做了优化，不取值，服务层直接按行进行累加<br>count (主键)<br>InnoDB 引擎会遍历整张表，把每一行的主键 id 值都取出来，这返回给服务层服务层拿到主键后，直接按行进行累加 (主键不可能为 null)<br>count (字段)<br>没有 notnull 约束：InnoDB 引擎会遍历整张表把每一行的字段值都取出来，返回给服务层，服务层判断是否为 null，不为 null，计数累加。<br>有 notnull 约束：InnoDB 引擎会遍历整张表把每一行的字段值都取出来，返回给服务层，直接按行进行累加<br>count (1)<br>InnoDB 引擎遍历整张表，但不取值。服务层对于返回的每一行，放一个数字 “1” 进去，直接按行进行累加</li></ul><p><code>按照效率排序的话，count(字段)&lt;count(主键id)&lt;count(1)≈count(*)，所以尽量使用count(*)</code></p><h2 id="update优化"><a class="anchor" href="#update优化">#</a> update 优化</h2><p>InnoDB 的行锁是针对索引加的锁，不是针对记录加的锁，并且该索引不能失效，否则会从行锁升级为表锁</p><h1 id="视图存储过程触发器"><a class="anchor" href="#视图存储过程触发器">#</a> 视图 / 存储过程 / 触发器</h1><h2 id="视图"><a class="anchor" href="#视图">#</a> 视图</h2><ul><li><p>介绍<br>视图（View）是一种虚拟存在的表。视图中的数据并不在数据库中实际存在，行和列数据来自定义视图的查询中使用的表，并且是在使用视<br>图时动态生成的</p></li><li><p>创建<br><code>create view 视图名称[(列名列表)] as select语句 [with[cascaded | local]check option]</code></p></li><li><p>查询<br>查看创建视图语句：show create view 视图名称；<br>查看视图数据：select * from 视图名称；</p></li><li><p>修改<br><code>方式1：create [or replace ]view 视图名称[(列名列表)] as select语句 [with[cascaded | local]check option]</code><br><code>方式2：alter view 视图名称[(列表名称)] as select 语句 [with[cascaded | local]check option]</code></p></li><li><p>删除<br><code>drop view [if exists] 视图名称 ;</code></p></li><li><p>视图检查选项<br>当使用 WITH CHECK OPTION 子句创建视图时，MySQL 会通过视图检查正在更改的每个行，例如插入，更新，删除，以使其符合视图的定<br>义。MySQL 允许基于另一个视图创建视图，它还会检查依赖视图中的规则以保持一致性。为了确定检查的范围，mysql 提供了两个选项：<br>CASCADED 和 LOCAL，默认值为 CASCADED</p></li><li><p>视图的更新<br>要使视图可更新，视图中的行与基础表中的行之间必须存在一对一的关系。如果视图包含以下任何一项，则该视图不可更新：</p><ol><li>聚合函数或窗口（sum ()、min ()、max ()、count () 等）</li><li>distinct</li><li>group by</li><li>having</li><li>union 或者 union all</li></ol></li><li><p>作用：<br>简单<br>视图不仅可以简化用户对数据的理解，也可以简化他们的操作。那些被经常使用的查询可以被定义为视图，从而使得用户不必为以后的操作<br>每次指定全部的条件<br>安全<br>数据库可以授权 但不能授权到数据库特定行和特定的列上 通过视图用户只能查询和修改他们所能见到的数据<br>数据独立<br>视图可帮助用户屏蔽真实表结构变化带来的影响</p></li></ul><h2 id="存储过程"><a class="anchor" href="#存储过程">#</a> 存储过程</h2><h3 id="介绍-2"><a class="anchor" href="#介绍-2">#</a> 介绍</h3><p>存储过程是事先经过编译并存储在数据库中的一段 SQL 语句的集合，调用存储过程可以简化应用开发人员的很多工作，减少数据在数据<br>库和应用服务器之间的传输，对于提高数据处理的效率是有好处的。<br>存储过程思想上很简单，就是数据库 SQL 语言层面的代码封装与重用。</p><ul><li>特点：<br>封装 复用<br>可以接收参数 也可以返回数据<br>减少网络交互 效率提升</li></ul><h3 id="创建"><a class="anchor" href="#创建">#</a> 创建</h3><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span>  存储过程名称<span class="token punctuation">(</span><span class="token punctuation">[</span>参数列表<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="3"></td><td><pre>     <span class="token comment">-- sql 语句</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul><li>调用<br><code>call 名称([参数])</code></li><li>删除<br><code>drop procedure 表名;</code></li><li>注意：在命令行中，执行创建存储过程的 SQL 时，需要通过关键字 delimiter 指定 SQL 语句的结束符</li></ul><h3 id="变量"><a class="anchor" href="#变量">#</a> 变量</h3><ul><li>系统变量<br>MySQL 服务器提供，不是用户定义的，属于服务器层面。分为全局变量（GLOBAL）、会话变量（SESSION)</li><li>查看系统变量<br><code>show [session | global] variables;</code> ---- 查看所有系统变量<br><code>show [session | global] variables like'……'</code> -- 可以通过 like 模糊匹配方式查找变量<br><code>select @@[session | global] 系统变量名;</code> ------- 查看指定变量的值</li><li>设置系统变量<br><code>set [session | global]系统变量名=值;</code><br><code>set @@[session | global]系统变量名=值;</code></li><li>用户定义变量<br>用户根据需要自己定义的变量，用户变量不用提前声明，在用的时候直接用 “@变量名” 使用就可以 其作用域为当前<br>连接</li><li>赋值<br><code>set @自定义变量名=值;</code><br><code>set @自定义变量名:=值;</code><br><code>select @自定义变量名 :=值;</code><br><code>select 字段名 into 变量名 from 表名;</code></li><li>使用<br><code>select @自定义变量名;</code></li><li>注意:<br>用户定义的变量无需对其进行声明或初始化，只不过获取到的值为 NULL</li><li>局部变量:<br>根据需要定义的在局部生效的变量，访问之前，需要 DECLARE 声明。可用作存储过程内的局部变量和输入参数，局部变量<br>的范围是在其内声明的 BEGIN...END 块。</li><li>声明<br><code>declare 变量名 变量类型[default];</code></li><li>变量类型就是数据库字段类型：INT、BIGINT、CHAR、VARCHAR、DATE、TIME 等</li><li>赋值<br><code>set 变量名=值;</code><br><code>set 变量名:=值;</code><br><code>select 字段名 into 变量名 from 表名;</code></li><li>示例</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> p<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">-- 声明 </span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">declare</span> stu_count <span class="token keyword">int</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">-- 赋值</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">from</span> <span class="token keyword">into</span> stu_count <span class="token keyword">from</span> student<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">-- 查询</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">select</span> stu_count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="if语法"><a class="anchor" href="#if语法">#</a> if 语法</h3><p><code>if 条件1 then else if 条件2 then else end if;</code></p><ul><li>示例：</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> p1<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">declare</span> score <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">60</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">declare</span> result <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> score<span class="token operator">>=</span><span class="token number">85</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">set</span> result:<span class="token operator">=</span><span class="token string">'优秀'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">elseif</span> score<span class="token operator">>=</span><span class="token number">60</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">set</span> result:<span class="token operator">=</span><span class="token string">'及格'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">set</span> result:<span class="token operator">=</span><span class="token string">'不及格'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">select</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">-- 调用</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">call</span> p1<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="参数"><a class="anchor" href="#参数">#</a> 参数</h3><table><thead><tr><th style="text-align:center">类型</th><th style="text-align:center">含义</th><th style="text-align:center">备注</th></tr></thead><tbody><tr><td style="text-align:center">in</td><td style="text-align:center">该类参数作为输入，也就是需要调用时传入值</td><td style="text-align:center">默认</td></tr><tr><td style="text-align:center">out</td><td style="text-align:center">该类参数作为输出，也就是该参数可以作为返回值</td></tr><tr><td style="text-align:center">inout</td><td style="text-align:center">既可以作为输入参数，也可以作为输出参数</td></tr></tbody></table><ul><li>用法</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> 存储过程名称<span class="token punctuation">(</span><span class="token operator">in</span><span class="token operator">/</span><span class="token keyword">out</span><span class="token operator">/</span><span class="token keyword">inout</span> 参数 参数类型<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">sql</span>语句</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul><li>示例</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- in out</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> p1<span class="token punctuation">(</span><span class="token operator">in</span> score <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">out</span>  result <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> score<span class="token operator">>=</span><span class="token number">85</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">set</span> result:<span class="token operator">=</span><span class="token string">'优秀'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">elseif</span> score<span class="token operator">>=</span><span class="token number">60</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">set</span> result:<span class="token operator">=</span><span class="token string">'及格'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">set</span> result:<span class="token operator">=</span><span class="token string">'不及格'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">call</span> p1<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token variable">@result</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">select</span> <span class="token variable">@result</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">-- inout</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> p2<span class="token punctuation">(</span><span class="token keyword">inout</span> score <span class="token keyword">double</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">set</span> score:<span class="token operator">=</span>score<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">set</span> <span class="token variable">@score</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">call</span> p2<span class="token punctuation">(</span><span class="token variable">@score</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">select</span> <span class="token variable">@score</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="case"><a class="anchor" href="#case">#</a> case</h3><ul><li>用法示例：</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> p3<span class="token punctuation">(</span><span class="token operator">in</span> <span class="token keyword">month</span> <span class="token keyword">int</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">declare</span> result <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">case</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">>=</span> <span class="token number">1</span> <span class="token operator">and</span> <span class="token keyword">month</span> <span class="token operator">&lt;=</span> <span class="token number">3</span> <span class="token keyword">then</span> <span class="token keyword">set</span> result :<span class="token operator">=</span> <span class="token string">'第一季度'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">between</span> <span class="token number">4</span> <span class="token operator">and</span> <span class="token number">6</span> <span class="token keyword">then</span> <span class="token keyword">set</span> result:<span class="token operator">=</span><span class="token string">'第二季度'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">between</span> <span class="token number">7</span> <span class="token operator">and</span> <span class="token number">9</span> <span class="token keyword">then</span> <span class="token keyword">set</span> result:<span class="token operator">=</span><span class="token string">'第三季度'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">when</span> <span class="token keyword">month</span> <span class="token operator">between</span> <span class="token number">10</span> <span class="token operator">and</span> <span class="token number">12</span> <span class="token keyword">then</span> <span class="token keyword">set</span> result:<span class="token operator">=</span><span class="token string">'第四季度'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">else</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">set</span> result:<span class="token operator">=</span><span class="token string">'非法参数'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">end</span> <span class="token keyword">case</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token string">'您输入的月份为：'</span><span class="token punctuation">,</span><span class="token keyword">month</span><span class="token punctuation">,</span><span class="token string">'所属的季度：'</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">call</span> p3<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="while循环"><a class="anchor" href="#while循环">#</a> while 循环</h3><p>while 循环是有条件的循环控制语句 满足条件后 再执行循环体中的 sql 语句 具体语法：</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 先判断条件 如果条件为 ture 则执行逻辑 否则 不执行逻辑</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">while</span> 条件 <span class="token keyword">do</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token keyword">sql</span>逻辑</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul><li>示例：</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 计算从 1 累加到 n 的值 n 为传入参数值</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> p4<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">while</span> n<span class="token operator">></span><span class="token number">0</span> <span class="token keyword">do</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">set</span> total:<span class="token operator">=</span>total<span class="token operator">+</span>n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">set</span> n:<span class="token operator">=</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">select</span> total<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">call</span> p4<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="repeat循环"><a class="anchor" href="#repeat循环">#</a> repeat 循环</h3><p>repeat 是有条件的循环控制语句 当满足条件的时候退出循环</p><ul><li>语法：先执行一次逻辑 然后判定逻辑是否满足 如果满足 则退出 如果不满足 则继续下一次循环<br><code>repeat sql逻辑…… until 条件 end repeat;</code></li><li>示例</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 计算从 1 累加到 n 的值 n 为传入参数值</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> p5<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">repeat</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">set</span> total:<span class="token operator">=</span>total<span class="token operator">+</span>n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">set</span> n:<span class="token operator">=</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    until n<span class="token operator">&lt;=</span><span class="token number">0</span> <span class="token keyword">end</span> <span class="token keyword">repeat</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">select</span> total<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">call</span> p5<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="loop循环"><a class="anchor" href="#loop循环">#</a> loop 循环</h3><p>loop 实现简单的循环 如果不在 sql 逻辑中增加退出循环的条件 可以用其来实现简单的死循环 loop 可以配合一下两个语句使用：</p><ul><li>leave：配合循环使用 退出循环</li><li>iterate：必须用在循环中 作用是跳过当前循环剩下的语句 直接进入下一次循环</li><li>语法：</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>begin_label:<span class="token punctuation">]</span><span class="token keyword">loop</span> </pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token keyword">sql</span>逻辑 </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">end</span> <span class="token keyword">loop</span> <span class="token punctuation">[</span>end_label<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">leave</span> label:<span class="token comment">-- 退出指定标记的循环体</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">iterate</span> label<span class="token punctuation">;</span> <span class="token comment">-- 直接进入下一次循环</span></pre></td></tr></table></figure><ul><li>示例</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 计算从 1 累加到 n 的值 n 为传入参数值</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> p6<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    sum:<span class="token keyword">loop</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">if</span> n<span class="token operator">&lt;=</span><span class="token number">0</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token keyword">leave</span> sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">set</span> total:<span class="token operator">=</span>total<span class="token operator">+</span>n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">set</span> n:<span class="token operator">=</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">end</span> <span class="token keyword">loop</span> sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">select</span> total<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">call</span> p6<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">-- 计算从 1 到 n 之间的偶数累加的值 n 为传入的参数值</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> p6<span class="token punctuation">(</span><span class="token operator">in</span> n <span class="token keyword">int</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>sum:<span class="token keyword">loop</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">if</span> n<span class="token operator">&lt;=</span><span class="token number">0</span> <span class="token keyword">then</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">leave</span> sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">set</span> total:<span class="token operator">=</span>total<span class="token operator">+</span>n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">set</span> n:<span class="token operator">=</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">end</span> <span class="token keyword">loop</span> sum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">select</span> total<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">call</span> p6<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="游标"><a class="anchor" href="#游标">#</a> 游标</h3><p>游标（CURSOR）是用来存储查询结果集的数据类型，在存储过程和函数中可以使用游标对结果集进行循环的处理。游标的使用包括游标<br>的声明、OPEN (开启) FETCH (获取) 和 CLOSE (关闭) 其语法分别如下</p><ul><li>声明游标<br><code>declare 游标名称 cursor for 查询语句;</code></li><li>打开游标<br><code>open 游标名称;</code></li><li>获取游标记录<br><code>fetch 游标名称 into 变量[变量];</code></li><li>关闭游标<br><code>close 游标名称;</code></li><li>示例</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">procedure</span> p8<span class="token punctuation">(</span><span class="token operator">in</span> uage <span class="token keyword">int</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">-- 声明游标</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">declare</span> uname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">declare</span> ujob <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">declare</span> u_cursor <span class="token keyword">cursor</span> <span class="token keyword">for</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>job <span class="token keyword">from</span> emp <span class="token keyword">where</span> age <span class="token operator">&lt;=</span> uage<span class="token punctuation">;</span><span class="token comment">-- 存储在 u_cursor 中</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">-- 声明条件处理程序 当满足 sql 状态码为 02000 触发退出操作并且关闭游标</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">declare</span> <span class="token keyword">exit</span> <span class="token keyword">handler</span> <span class="token keyword">for</span> sqlstate <span class="token string">'02000'</span> <span class="token keyword">close</span> u_cursor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">-- 先删除再创建</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> tb_user_pro<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> tb_user_pro<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    job <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">-- 开启游标</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">open</span> u_cursor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">-- 循环获取游标数据</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">while</span> <span class="token boolean">true</span> <span class="token keyword">do</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">fetch</span> u_cursor <span class="token keyword">into</span> uname<span class="token punctuation">,</span>ujob<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">-- 获取的数据再插入到新表当中</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">insert</span> <span class="token keyword">into</span> tb_user_pro <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span>uname<span class="token punctuation">,</span>ujob<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">-- 关闭游标</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">close</span> u_cursor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">call</span> p8<span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="条件处理程序"><a class="anchor" href="#条件处理程序">#</a> 条件处理程序</h3><p>条件处理程序（Handler）可以用来定义在流程控制结构执行过程中遇到问题时相应的处理步骤。具体语法为：<br><img data-src="/picture/QQ20250721-174204.png" alt="图片"><br><span class="exturl" data-url="aHR0cHM6Ly9kZXYubXlzcWwuY29tL2RvYy9teXNxbC1lcnJvcnMvOC4wL2VuL3NlcnZlci1lcnJvci1yZWZlcmVuY2UuaHRtbA==">https://dev.mysql.com/doc/mysql-errors/8.0/en/server-error-reference.html</span></p><h2 id="存储函数"><a class="anchor" href="#存储函数">#</a> 存储函数</h2><p>存储函数是有返回值的存储过程存储函数的参数只能是 IN 类型的。具体语法如下：<br><img data-src="/picture/QQ20250721-180339.png" alt="图片"></p><ul><li>示例</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 计算从 1 累加到 n 的值 n 为传入参数值</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">function</span> fun1<span class="token punctuation">(</span>n <span class="token keyword">int</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">returns</span> <span class="token keyword">int</span> <span class="token keyword">deterministic</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">declare</span> total <span class="token keyword">int</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">while</span> n<span class="token operator">></span><span class="token number">0</span> <span class="token keyword">do</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">set</span> total:<span class="token operator">=</span>total<span class="token operator">+</span>n<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">set</span> n:<span class="token operator">=</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">end</span> <span class="token keyword">while</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> total<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">select</span> fun1<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h2 id="触发器"><a class="anchor" href="#触发器">#</a> 触发器</h2><h3 id="介绍-3"><a class="anchor" href="#介绍-3">#</a> 介绍</h3><p>触发器是与表有关的数据库对象，指在 insert/update/delete 之前或之后，触发并执行触发器中定义的 SQL 语句集合。触发器的这种特<br>性可以协助应用在数据库端确保数据的完整性，日志记录，数据校验等操作。<br>使用别名 OLD 和 NEW 来引用触发器中发生变化的记录内容，这与其他的数据库是相似的。现在触发器还只支持行级触发，不支持语句<br>级触发</p><table><thead><tr><th>触发器类型</th><th>new 和 old</th></tr></thead><tbody><tr><td>insert</td><td>new 表示将要或者已经新增的数据</td></tr><tr><td>update</td><td>old 表示修改之前的数据 new 表示将要或已经修改后的数据</td></tr><tr><td>delete</td><td>old 表示将要或者已经删除的数据</td></tr></tbody></table><h3 id="语法"><a class="anchor" href="#语法">#</a> 语法</h3><ul><li>创建</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">trigger</span> 触发器名称</pre></td></tr><tr><td data-num="2"></td><td><pre>之前触发选:before 之后触发选:<span class="token keyword">after</span> 类型:insetr<span class="token operator">/</span><span class="token keyword">update</span><span class="token operator">/</span><span class="token keyword">delete</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">on</span> 表名 <span class="token keyword">for each row</span><span class="token comment">-- 行级触发器</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    触发器逻辑实现</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr></table></figure><ul><li>查看<br><code>show triggers;</code></li><li>删除<br><code>drop trigger [schema_name] 触发器名称-- 如果没有指定schema_name 默认为当前数据库</code></li><li>示例</li></ul><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 准备表</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">table</span> tb_user<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                      id <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'id'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                      name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">comment</span><span class="token string">'姓名'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                      phone <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'手机号'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                      email <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                      profession <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'职业'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                      age <span class="token keyword">int</span> <span class="token keyword">comment</span> <span class="token string">'年龄'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                      gender <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'性别'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>                      createtime <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">comment</span> <span class="token string">'创建时间'</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">)</span> <span class="token keyword">comment</span><span class="token string">'表'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">-- 更新日志</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">table</span> user_logs<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                        id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                        operation <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'操作类型,insert/update/delete'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                        operate_time <span class="token keyword">datetime</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'操作时间'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                        operate_id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">'操作的iD'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                        operate_params <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token keyword">comment</span><span class="token string">'操作参数'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                        <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span> <span class="token keyword">default</span> <span class="token keyword">charset</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">-- 插入数据触发器</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">trigger</span> tb_user_insert_trigger</pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">after</span> <span class="token keyword">insert</span> <span class="token keyword">on</span> tb_user <span class="token keyword">for each row</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">insert</span> <span class="token keyword">into</span> user_logs<span class="token punctuation">(</span>id<span class="token punctuation">,</span>operation<span class="token punctuation">,</span>operate_time<span class="token punctuation">,</span>operate_id<span class="token punctuation">,</span>operate_params<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'insert'</span><span class="token punctuation">,</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token string">'插入的数据内容为：id='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id <span class="token punctuation">,</span><span class="token string">'name='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">'phone='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>phone<span class="token punctuation">,</span><span class="token string">'email='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>email<span class="token punctuation">,</span><span class="token string">'profession='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>profession<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">-- 修改触发器</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">trigger</span> tb_user_update_trigger</pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token keyword">after</span> <span class="token keyword">update</span> <span class="token keyword">on</span> tb_user <span class="token keyword">for each row</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token keyword">insert</span> <span class="token keyword">into</span> user_logs<span class="token punctuation">(</span>id<span class="token punctuation">,</span>operation<span class="token punctuation">,</span>operate_time<span class="token punctuation">,</span>operate_id<span class="token punctuation">,</span>operate_params<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'update'</span><span class="token punctuation">,</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id<span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token string">'更新之前的数据：id='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>id <span class="token punctuation">,</span><span class="token string">'name='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">'phone='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>phone<span class="token punctuation">,</span><span class="token string">'email='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>email<span class="token punctuation">,</span><span class="token string">'profession='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>profession<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                                            <span class="token string">'|更新之前的数据：id='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>id <span class="token punctuation">,</span><span class="token string">'name='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">'phone='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>phone<span class="token punctuation">,</span><span class="token string">'email='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>email<span class="token punctuation">,</span><span class="token string">'profession='</span><span class="token punctuation">,</span>new<span class="token punctuation">.</span>profession<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">-- 删除触发器</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">create</span> <span class="token keyword">trigger</span> tb_user_delete_trigger</pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">after</span> <span class="token keyword">delete</span> <span class="token keyword">on</span> tb_user <span class="token keyword">for each row</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">begin</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token keyword">insert</span> <span class="token keyword">into</span> user_logs<span class="token punctuation">(</span>id<span class="token punctuation">,</span>operation<span class="token punctuation">,</span>operate_time<span class="token punctuation">,</span>operate_id<span class="token punctuation">,</span>operate_params<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'delete'</span><span class="token punctuation">,</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>OLD<span class="token punctuation">.</span>id<span class="token punctuation">,</span>concat<span class="token punctuation">(</span><span class="token string">'删除之前的数据：id='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>id <span class="token punctuation">,</span><span class="token string">'name='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token string">'phone='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>phone<span class="token punctuation">,</span><span class="token string">'email='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>email<span class="token punctuation">,</span><span class="token string">'profession='</span><span class="token punctuation">,</span>old<span class="token punctuation">.</span>profession<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">end</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment">-- 查看触发器</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token keyword">show</span> triggers <span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">-- 插入</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token keyword">insert</span> <span class="token keyword">into</span> tb_user<span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>phone<span class="token punctuation">,</span>email<span class="token punctuation">,</span>profession<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span>createtime<span class="token punctuation">)</span><span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'张三'</span><span class="token punctuation">,</span><span class="token string">'123456467897'</span><span class="token punctuation">,</span><span class="token string">'sfdsf13'</span><span class="token punctuation">,</span><span class="token string">'教师'</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token string">'女'</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">-- 修改</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token keyword">update</span>  tb_user <span class="token keyword">set</span> age<span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment">-- 删除记录</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token keyword">delete</span> <span class="token keyword">from</span> tb_user <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h1 id="锁"><a class="anchor" href="#锁">#</a> 锁</h1><h2 id="概述"><a class="anchor" href="#概述">#</a> 概述</h2><ul><li>介绍<br>锁是计算机协调多个进程或线程并发访问某一资源的机制。在数据库中，除传统的计算资源（CPU、RAM、I/O）的争用以外，数据也是<br>一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访<br>问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂</li><li>分类<br>mysql 的锁 按照锁的粒度分 分为一下三类：</li></ul><ol><li>全局锁：锁定数据库中的所有表</li><li>表级锁：每次操作锁住整张表</li><li>行级锁：每次操作锁住对应的行数据</li></ol><h2 id="全局锁"><a class="anchor" href="#全局锁">#</a> 全局锁</h2><ul><li>介绍<br>全局锁就是对整个数据库实例加锁 加锁后整个实例就处于只读状态 后续的 DML 的写语句、DDL 语句 已经更新操作的事务提交语句都将被阻塞<br>其典型的使用场景是做全库的逻辑备份，对所有的表进行锁定，从而获取一致性视图，保证数据的完整性</li><li>语法<br>加全局锁： <code>flush tables with read lock;</code><br>在 windows 系统命令行当中执行备份： <code>mysqldump -u用户 -p密码 数据库&gt;sql文件</code><br>解锁： <code>unlock tables;</code></li><li>特点：<br>数据库中加全局锁，是一个比较重的操作，存在以下问题：</li></ul><ol><li>如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆。</li><li>如果在从库上备份，那么在备份期间从库不能执行主库同步过来的二进制日志（binlog），会导致主从延迟<br>在 InnoDB 引擎中，我们可以在备份时加上参数 --single-transaction 参数来完成不加锁的一致性数据备份<br><code>mysqldump --single-transaction -u用户 -p密码 数据库&gt;sql文件</code></li></ol><h2 id="表级锁"><a class="anchor" href="#表级锁">#</a> 表级锁</h2><ul><li>介绍<br>表级锁，每次操作锁住整张表 锁定粒度大，发生锁冲突的概率最高，并发度最低。应用在 MyISAM、InnoDB、BDB 等存储引擎中</li><li>对于表级锁 主要分为以下三类：</li></ul><ol><li>表锁</li><li>元数据锁（meta data lock,MDL）</li><li>意向锁</li></ol><h3 id="表锁"><a class="anchor" href="#表锁">#</a> 表锁</h3><ul><li>对于表锁 分为两类：</li></ul><ol><li>表独享读锁（read lock）当前客户端只能读不能写 其他客户端也只能读不能写</li><li>表独占写锁（write lock）当前客户端能读能写 其他客户端既不能读也不能写<br><code>读锁不会阻塞其他客户端的读，但是会阻塞写。写锁既会阻塞其他客户端的读，又会阻塞其他客户端的写</code></li></ol><ul><li>语法</li></ul><ol><li>加锁： <code>lock tables 表名 read/write</code></li><li>释放锁： <code>unlock tables/客户端断开连接</code></li></ol><h3 id="元数据锁"><a class="anchor" href="#元数据锁">#</a> 元数据锁</h3><p>MDL 加锁过程是系统自动控制，无需显式使用，在访问一张表的时候会自动加上。MDL 锁主要作用是维护表元数据的数据一致性，在表<br>上有活动事务的时候，不可以对元数据进行写入操作 <code>为了避免DML与DDL冲突，保证读写的正确性</code><br>在 MySQL（5.5）中引入了 MDL，当对一张表进行增删改查的时候，自动加 MDL 读锁 (共享)；当对表结构进行变更操作的时候，自动加 MDL 写锁 (排他）</p><table><thead><tr><th style="text-align:center">对应 sql</th><th style="text-align:center">锁类型</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">lock tables xxx read /write</td><td style="text-align:center">SHARED_READ_ONLY/SHARED_NO_READ_WRITE</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">select 、select ... lock in share mode</td><td style="text-align:center">SHARED_READ</td><td style="text-align:center">与 SHARED_READ、SHARED_WRITE 兼容，与 EXCLUSIVE 互斥</td></tr><tr><td style="text-align:center">insert 、update、delete、select...for update</td><td style="text-align:center">SHARED_WRITE</td><td style="text-align:center">与 SHARED_READ、SHARED_WRITE 兼容，与 EXCLUSIVE 互斥</td></tr><tr><td style="text-align:center">alter table ...</td><td style="text-align:center">EXCLUSIVE</td><td style="text-align:center">与其他的 MDL 都互斥</td></tr></tbody></table><ul><li>查看元数据锁<br><code>select object_type,object_schema,object_name,lock_type,lock_duration from performance_schema.metadata_locks</code></li></ul><h3 id="意向锁"><a class="anchor" href="#意向锁">#</a> 意向锁</h3><p>为了避免 DML 在执行时，加的行锁与表锁的冲突，在 InnoDB 中引入了意向锁，使得表锁不用检查每行数据是否加锁，使用意向锁来减少表锁的检查</p><ol><li>意向共享锁（is）由语句 select ... lock in share mode 添加</li><li>意向排他锁（ix）由 insert、update、delete、select... for update 添加</li></ol><ul><li>意向共享锁 (IS）：与表锁共享锁（read）兼容，与表锁排它锁 (write）互斥</li><li>意向排他锁 (IX）：与表锁共享锁（read）及排它锁（write）都互斥。意向锁之间不会互斥</li><li>可以通过一下 sql 查看意向锁级行锁的加锁情况<br><code>select object_schema,object_name,index_name,lock_type,lock_mode,lock_data from performance_schema.data_locks;</code></li></ul><h2 id="行级锁"><a class="anchor" href="#行级锁">#</a> 行级锁</h2><ul><li>介绍<br>行级锁，每次操作锁住对应的行数据。锁定粒度最小，发生锁冲突的概率最低，并发度最高。应用在 InnoDB 存储引擎中</li><li>InnoDB 的数据是基于索引组织的，行锁是通过对索引上的索引项加锁来实现的，而不是对记录加的锁。对于行级锁，主要分为以下三类：<ol><li>行锁（Record Lock)：锁定单个行记录的锁，防止其他事务对此行进行 update 和 delete。在 RC、RR 隔离级别下都支持</li><li>间隙锁（GapLock)：锁定索引记录间隙产生幻读。在在 RR 隔离级别下都支持</li><li>临键锁（Next-KeyLock）：行锁和间隙锁组合，同时锁住数据，并锁住数据前面的间隙 Gap。在 RR 隔离级别下支持</li></ol></li><li>InnoDB 实现了以下两种类型的行锁：</li></ul><ol><li><p>共享锁（S）：允许事务去读一行，阻止其他事务获得相同数据集的排他锁。</p></li><li><p>排他锁（X）：允许获取排他锁的事务更新数据，阻止其他事务获得相同数据集的共享锁和排他锁<br><img data-src="/picture/QQ20250722-202018.png" alt="图片"></p><p><img data-src="/picture/QQ20250722-202439.png" alt="图片"></p></li></ol><ul><li>默认情况下，InnoDB 在 REPEATABLEREAD 事务隔离级别运行，InnoDB 使用 next-key 锁进行搜索和索引 I 扫描，以防止幻读。<ol><li>针对唯一索引进行检索时，对已存在的记录进行等值匹配时，将会自动优化为行锁。</li><li>InnoDB 的行锁是针对于索引加的锁，不通过索引条件检索数据，那么 InnoDB 将对表中的所有记录加锁， <code>此时就会升级为表锁</code></li></ol></li><li>可以通过一下 sql 查看意向锁及行锁的加锁情况：<br><code>select object_schema,object_name,index_name,lock_type,lock_mode,lock_data from performance_schema.data_locks;</code></li><li>默认情况下，InnoDB 在 REPEATABLEREAD 事务隔离级别运行，InnoDB 使用 next-key 锁进行搜索和索引扫描，以防止幻读。<ol><li>索引上的等值查询 (唯一索引)，给不存在的记录加锁时，优化为间隙锁。</li><li>索引上的等值查询 (普通索引)，向右遍历时最后一个值不满足查询需求时，next-key lock 退化为间隙锁</li><li>索引上的范围查询 (唯一索引)-- 会访问到不满足条件的第一个值为止。<br><code>注意：间隙锁唯一目的是防止其他事务插入间隙。间隙锁可以共存，一个事务采用的间隙锁不会阻止另一个事务在同一间隙上采用间隙锁</code></li></ol></li></ul><h2 id="总结"><a class="anchor" href="#总结">#</a> 总结</h2><ol><li>概述：在并发访问时，解决数据访问的一致性、有效性问题 分：全局锁、表级锁、行级锁</li><li>全局锁：对整个数据库实例加锁，加锁后整个实例就处于只读状态 性能较差，数据逻辑备份时使用</li><li>表级锁：操作锁住整张表，锁定粒度大，发生锁冲突的概率高 分：表锁、元数据锁、意向锁</li><li>行级锁：操作锁住对应的行数据，锁定粒度最小，发生锁冲突的概率最低 分：行锁、间隙锁、临键锁</li></ol><h1 id="innodb引擎"><a class="anchor" href="#innodb引擎">#</a> InnoDB 引擎</h1><h2 id="逻辑存储结构"><a class="anchor" href="#逻辑存储结构">#</a> 逻辑存储结构</h2><ul><li>逻辑存储结构<br><img data-src="/picture/QQ20250715-185017.png" alt="图片"></li><li>表空间（ibd 文件），一个 mysql 实例可以对应多个表空间，用于存储记录、索引等数据</li><li>段，分为数据段 (Leaf node segment)、索引段 (Non-leaf node segment)、回滚段 (Rollback segment)，InnoDB<br>是索引组织表，数据段就是 B + 树的叶子节点，索引段即为 B + 树的非叶子节点。段用来管理多个 Extent（区）</li><li>区，表空间的单元结构，每个区的大小为 1M。默认情况下，InnoDB 存储引擎页大小<br>为 16K，即一个区中一兵有 64 个连续的页</li><li>页，晨 InnoDB 存储引擎磁盘管理的最小单元，每个页的大小默认为 16KB。为了保证页的连续性，InnoDB 存储引擎每次从<br>磁盘申请 4-5 个区</li><li>行，InnoDB 存储引擎数据是按行进行存放的<br>Trx_id：每次对某条记录进行改动时，都会把对应的事务 id 赋值给 trx_id 隐藏列<br>Roll_pointer：每次对某条引记录进行改动时，都会把旧的版本写入到 undo 日志中 然后这个隐藏列就相当于个指针，可以通过它来找到该记录修改前的信息</li></ul><h2 id="架构"><a class="anchor" href="#架构">#</a> 架构</h2><p>MySQL5.5 版本开始，默认使用 InnoDB 存储引擎，它擅长事务处理，具有崩溃恢复特性，在日常开发中使用非常广泛。下面是 InnoDB 架构图，左侧为内存结构，右<br>侧为磁盘结构</p><h3 id="内存结构"><a class="anchor" href="#内存结构">#</a> 内存结构</h3><p><img data-src="/picture/QQ20250723-162937.png" alt="图片"><br><img data-src="/picture/QQ20250723-163719.png" alt="图片"><br><img data-src="/picture/QQ20250723-165939.png" alt="图片"><br><img data-src="/picture/QQ20250723-170314.png" alt="图片"><br><img data-src="/picture/QQ20250723-171616.png" alt="图片"></p><h3 id="磁盘结构"><a class="anchor" href="#磁盘结构">#</a> 磁盘结构</h3><p><img data-src="/picture/QQ20250723-173603.png" alt="图片"><br><img data-src="/picture/QQ20250723-173826.png" alt="图片"><br><img data-src="/picture/QQ20250723-174220.png" alt="图片"></p><h3 id="后台线程"><a class="anchor" href="#后台线程">#</a> 后台线程</h3><p><img data-src="/picture/QQ20250723-174645.png" alt="图片"><br><img data-src="/picture/QQ20250723-175652.png" alt="图片"></p><h2 id="事务原理"><a class="anchor" href="#事务原理">#</a> 事务原理</h2><ul><li><p>事务<br>事务是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作<br>要么同时成功，要么同时失败。</p></li><li><p>特性<br>原子性（Atomicity）：事务是不可分割的最小操作单元，要么全部成功，要么全部失败<br>一致性（Consistency）：事务完成时，必须使所有的数据都保持一致状态<br>隔离性（Isolation）：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行<br>持久性（Durability）：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的</p></li><li><p>redo log （持久性）<br>重做日志，记录的是事务提交时数据页的物理修改，是用来实现事务的持久性。<br>该日志文件由两部分组成：重做日志缓冲 (redo log buffer) 以及重做日志文件 (redo log file），前者是在内存中，后者在磁盘中 当事务<br>提交之后会把所有修改信息都存到该日志文件中，用于在刷新脏页到磁盘，发生错误时，进行数据恢复使用</p></li><li><p>undo log（原子性）<br>回滚日志，于记录数据被修改前的信息，作用包含两个：提供回滚和 MVCC (多版本并发控制)。<br>undo log 和 redo log 记录物理日志不一样，它是逻辑日志。可以认为当 delete 一条记录时，undo log 中会记录一条对应的 insert 记录，反之<br>亦然，当 update 一条记录时，它记录一条对应相反的 update 记录。当执行 rollback 时，就可以从 undolog 中的逻辑记录读取到相应的内容<br>并进行回滚。<br>Undo log 销毁：undo log 在事务执行时产生，事务提交时，并不会立即删除 undo log，因为这些日志可能还用于 MVCC。<br>Undo log 存储：undo log 采用段的方式进行管理和记录，存放在前面介绍的 rollback segment 回滚段中，内部包含 1024 个 undo log<br>segment。</p></li></ul><h2 id="mvcc"><a class="anchor" href="#mvcc">#</a> MVCC</h2><h3 id="mvcc-基本概念"><a class="anchor" href="#mvcc-基本概念">#</a> MVCC - 基本概念</h3><ul><li>当前读<br>读取的是记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。对于我们日常的操作，如：<br>select...lock in share mode (共毫锁), select...for update、update、insert、delete (排他锁) 都是一种当前读</li><li>快照读<br>简单的 select（不加锁）就是快照读，快照读，读取的是记录数据的可见版本，有可能是历史数据，不加锁，是非阻塞读。<br>Read Committed：每次 select，都生成一个快照读。<br>Repeatable Read：开启事务后第一个 select 语句才是快照读的地方<br>Serializable：快照读会退化为当前读。</li><li>MVCC<br>全称 Muti-VersionConcurrency Control，多版本并发控制。指维护一个数据的多个版本，使得读写操作没有冲突，快照读为 MySQL 实现<br>MVCC 提供了一个非阻塞读功能。MVcC 的具体实现，还需要依赖于数据库记录中的三个隐式字段、undo log 日志、readView</li></ul><h3 id="mvcc-实现原理"><a class="anchor" href="#mvcc-实现原理">#</a> MVCC - 实现原理</h3><ul><li>记录中的隐藏字段</li></ul><table><thead><tr><th style="text-align:center">隐藏字段</th><th style="text-align:center">含义</th></tr></thead><tbody><tr><td style="text-align:center">DB_TRX_ID</td><td style="text-align:center">最近修改事务 ID，记录插入这条记录或最后一次修改该记录的事务 ID</td></tr><tr><td style="text-align:center">DB_ROLL_PTR</td><td style="text-align:center">回滚指针 指向这条记录的上一个版本，用于配合 undo log，指向上一个版本</td></tr><tr><td style="text-align:center">DB_ROW_ID</td><td style="text-align:center">隐藏主键，如果表结构没有指定主键，将会生成该隐藏字段</td></tr></tbody></table><ul><li>undo log<br>回滚日志，在 insert、update、delete 的时候产生的便于数据回滚的目志。<br>当 insert 的时候，产生的 undolog 日志只在回滚时需要，在事务提交后，可被立即删除。<br>而 update、delete 的时候，产生的 undo log 日志不仅在回滚时需要，在快照读时也需要，不会立即被删除。</li><li>undo log 版本链</li><li>不同事务或相同事务对同一条记录进行修改，会导致该记录的 undolog 生成一条记录版本链表，链表的头部是最新的旧记录，链表尾部是最 以早的旧记录。<br><img data-src="/picture/QQ20250724-145611.png" alt="图片"></li><li>ReadView<br>ReadView（读视图）是快照读 SQL 执行时 MvCC 提取数据的依据，记录并维护系统当前活跃的事务（未提交的）id<br>ReadView 中包含了四个核心字段：</li></ul><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>m_ids</td><td>当前活跃的事务 ID 集合</td></tr><tr><td>min_trx_id</td><td>最小活跃事务 ID</td></tr><tr><td>max_trx_id</td><td>预分配事务 ID 当前最大事务 ID+1（因为事务 ID 是自增的）</td></tr><tr><td>creator_trx_id</td><td>ReadView 创建者的事务 ID</td></tr></tbody></table><p><img data-src="/picture/QQ20250724-152103.png" alt="图片"></p><ul><li>不同的隔离级别，生成 ReadView 的时机不同：<br><code>READ COMMITTED：在事务中每一次执行快照读时生成ReadView。</code><br><code>REPEATABLE READ：仅在事务中第一次执行快照读时成ReadView，后续复用该ReadView。</code></li></ul><h1 id="mysql管理"><a class="anchor" href="#mysql管理">#</a> MySQL 管理</h1><h2 id="系统数据库"><a class="anchor" href="#系统数据库">#</a> 系统数据库</h2><p>Mysql 数据库安装完成后，自带了一下四个数据库，具体作用如下：</p><table><thead><tr><th>数据库</th><th>含义</th></tr></thead><tbody><tr><td>mysql</td><td>存储 MySQL 服务器正常运行所需要的各种信息（时区、主从、用户、权限等）</td></tr><tr><td>information_schema</td><td>提供了访问数据库元数据的各种表和视图，包含数据库、表、字段类型及访问权限等</td></tr><tr><td>performance_schema</td><td>为 MySQL 服务器运行时状态提供了一个底层监控功能，主要用于收集数据库服务器性能参数</td></tr><tr><td>sys</td><td>包含了一系列方便 DBA 和开发人员利用 performance_schema 性能数据库进行性能调优和诊断的视图</td></tr></tbody></table><h2 id="常用工具"><a class="anchor" href="#常用工具">#</a> 常用工具</h2><ul><li><p>mysql<br>该 mysql 不是指 mysql 服务 而是指 mysql 的客户端工具<br><code>语法：mysql[options] [database]</code></p></li><li><p>选项：<br>-u --user=name---------# 指定用户名<br>- p --password---------# 指定密码<br>- h --host=name-------# 指定服务器 IP 或域名<br>- P --port=port-------# 指定连接端口<br>- e --execute=name----# 执行 sql 语句并退出</p></li><li><p>-e 选项可以在 MysqI 客户端执行 sQL 语句，而不用连接到 MySQL 数据库再执行，对于一些批处理脚本，这种方式尤其方便<br>示例<br><code>mysql -uroot -p123456 db01 -e'select * from stu';</code></p></li><li><p>mysqladmin<br>mysqladmin 是一个执行管理操作的客户端程序。可以用它来检查服务器的配置和当前状态、创建并删除数据库等</p></li><li><p>mysqlbinlog<br>由于服务器生成的二进制日志文件以二进制格式保存，所以如果想要检查这些文本的文本格式，就会使用到 mysqlbinlog 日志管理<br>工具<br><img data-src="/picture/QQ20250725-112108.png" alt="图片"></p></li><li><p>mysqlshow<br>mysqlshow 客户端对象查找工具，用来很快地查找存在哪些数据库、数据库中的表、表中的列或者索引。<br><img data-src="/picture/QQ20250725-112647.png" alt="图片"></p></li><li><p>mysqldump<br>mysqldump 客户端工具用来备份数据库或在不同数据库之间进行数据迁移。备份内容包含创建表，及插入表的 sql 语句<br><img data-src="/picture/QQ20250725-113336.png" alt="图片"></p></li><li><p>mysqlimport/source<br>mysqlimport 是客户端数据导入工具，用来导入 mysqldump 加 - T 参数后导出的文本文件</p></li><li><p>语法：<br><code>mysqlimport [options]db_name textfile1[textfile2……]</code></p></li><li><p>如果需要导入 sql 文件，可以使用 mysql 中的 source 指令：</p></li><li><p>语法：<br><code>source/root/xxxxx.sql</code></p></li></ul></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2025-07-25 11:49:36" itemprop="dateModified" datetime="2025-07-25T11:49:36+08:00">2025-07-25</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> Donate</button><p>Give me a cup of [coffee]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Years Pass WeChat Pay"><p>WeChat Pay</p></div><div><img data-src="/images/alipay.png" alt="Years Pass Alipay"><p>Alipay</p></div><div><img data-src="/images/paypal.png" alt="Years Pass PayPal"><p>PayPal</p></div></div></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>Years Pass <i class="ic i-at"><em>@</em></i>字节纪元</li><li class="link"><strong>Post link: </strong><a href="https://time-520.github.io/2025/07/15/MySQL%E8%BF%9B%E9%98%B6/" title="MySQL进阶">https://time-520.github.io/2025/07/15/MySQL进阶/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2025/07/07/MySQL/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;www.dmoe.cc&#x2F;random.php?62796" title="MySQL基础"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>MySQL基础</h3></a></div><div class="item right"><a href="/2025/07/26/csharp/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;www.dmoe.cc&#x2F;random.php?633685" title="C Sharp"><span class="type">Next Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>C Sharp</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-number">1.</span> <span class="toc-text">存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">mysql 体系结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.</span> <span class="toc-text">存储引擎简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%89%B9%E7%82%B9"><span class="toc-number">1.3.</span> <span class="toc-text">存储引擎特点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#innodb"><span class="toc-number">1.3.1.</span> <span class="toc-text">InnoDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#myisam"><span class="toc-number">1.3.2.</span> <span class="toc-text">MyISAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#memory"><span class="toc-number">1.3.3.</span> <span class="toc-text">Memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E7%82%B9%E8%A1%A8"><span class="toc-number">1.3.4.</span> <span class="toc-text">特点表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E9%80%89%E6%8B%A9"><span class="toc-number">1.4.</span> <span class="toc-text">存储引擎选择</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-number">2.</span> <span class="toc-text">索引</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">索引概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84"><span class="toc-number">2.2.</span> <span class="toc-text">索引结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.2.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#btree"><span class="toc-number">2.2.2.</span> <span class="toc-text">Btree</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#btree%E7%B4%A2%E5%BC%95"><span class="toc-number">2.2.3.</span> <span class="toc-text">B+tree 索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hash%E7%B4%A2%E5%BC%95"><span class="toc-number">2.2.4.</span> <span class="toc-text">Hash 索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB"><span class="toc-number">2.3.</span> <span class="toc-text">索引分类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E8%AF%AD%E6%B3%95"><span class="toc-number">2.4.</span> <span class="toc-text">索引语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sql%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="toc-number">2.5.</span> <span class="toc-text">SQL 性能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sql%E6%89%A7%E8%A1%8C%E9%A2%91%E7%8E%87"><span class="toc-number">2.5.1.</span> <span class="toc-text">sql 执行频率</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-number">2.5.2.</span> <span class="toc-text">慢查询日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#profile"><span class="toc-number">2.5.3.</span> <span class="toc-text">profile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#explain%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-number">2.5.4.</span> <span class="toc-text">explain 执行计划</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E4%BD%BF%E7%94%A8"><span class="toc-number">2.6.</span> <span class="toc-text">索引使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="toc-number">2.7.</span> <span class="toc-text">索引设计原则</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sql%E4%BC%98%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">SQL 优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">3.1.</span> <span class="toc-text">插入数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#insert%E4%BC%98%E5%8C%96"><span class="toc-number">3.1.1.</span> <span class="toc-text">insert 优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E9%94%AE%E4%BC%98%E5%8C%96"><span class="toc-number">3.2.</span> <span class="toc-text">主键优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#order-by%E4%BC%98%E5%8C%96"><span class="toc-number">3.3.</span> <span class="toc-text">order by 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#group-by%E4%BC%98%E5%8C%96"><span class="toc-number">3.4.</span> <span class="toc-text">group by 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#limit%E4%BC%98%E5%8C%96"><span class="toc-number">3.5.</span> <span class="toc-text">limit 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#count%E4%BC%98%E5%8C%96"><span class="toc-number">3.6.</span> <span class="toc-text">count 优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#update%E4%BC%98%E5%8C%96"><span class="toc-number">3.7.</span> <span class="toc-text">update 优化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">视图 &#x2F; 存储过程 &#x2F; 触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE"><span class="toc-number">4.1.</span> <span class="toc-text">视图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">4.2.</span> <span class="toc-text">存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-2"><span class="toc-number">4.2.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA"><span class="toc-number">4.2.2.</span> <span class="toc-text">创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-number">4.2.3.</span> <span class="toc-text">变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#if%E8%AF%AD%E6%B3%95"><span class="toc-number">4.2.4.</span> <span class="toc-text">if 语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0"><span class="toc-number">4.2.5.</span> <span class="toc-text">参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#case"><span class="toc-number">4.2.6.</span> <span class="toc-text">case</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#while%E5%BE%AA%E7%8E%AF"><span class="toc-number">4.2.7.</span> <span class="toc-text">while 循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#repeat%E5%BE%AA%E7%8E%AF"><span class="toc-number">4.2.8.</span> <span class="toc-text">repeat 循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#loop%E5%BE%AA%E7%8E%AF"><span class="toc-number">4.2.9.</span> <span class="toc-text">loop 循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B8%E6%A0%87"><span class="toc-number">4.2.10.</span> <span class="toc-text">游标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="toc-number">4.2.11.</span> <span class="toc-text">条件处理程序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"><span class="toc-number">4.3.</span> <span class="toc-text">存储函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="toc-number">4.4.</span> <span class="toc-text">触发器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-3"><span class="toc-number">4.4.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95"><span class="toc-number">4.4.2.</span> <span class="toc-text">语法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%94%81"><span class="toc-number">5.</span> <span class="toc-text">锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%94%81"><span class="toc-number">5.2.</span> <span class="toc-text">全局锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A8%E7%BA%A7%E9%94%81"><span class="toc-number">5.3.</span> <span class="toc-text">表级锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E9%94%81"><span class="toc-number">5.3.1.</span> <span class="toc-text">表锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E9%94%81"><span class="toc-number">5.3.2.</span> <span class="toc-text">元数据锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%84%8F%E5%90%91%E9%94%81"><span class="toc-number">5.3.3.</span> <span class="toc-text">意向锁</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%8C%E7%BA%A7%E9%94%81"><span class="toc-number">5.4.</span> <span class="toc-text">行级锁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#innodb%E5%BC%95%E6%93%8E"><span class="toc-number">6.</span> <span class="toc-text">InnoDB 引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="toc-number">6.1.</span> <span class="toc-text">逻辑存储结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">6.2.</span> <span class="toc-text">架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="toc-number">6.2.1.</span> <span class="toc-text">内存结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E7%BB%93%E6%9E%84"><span class="toc-number">6.2.2.</span> <span class="toc-text">磁盘结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B"><span class="toc-number">6.2.3.</span> <span class="toc-text">后台线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86"><span class="toc-number">6.3.</span> <span class="toc-text">事务原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mvcc"><span class="toc-number">6.4.</span> <span class="toc-text">MVCC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mvcc-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">6.4.1.</span> <span class="toc-text">MVCC - 基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mvcc-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">6.4.2.</span> <span class="toc-text">MVCC - 实现原理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mysql%E7%AE%A1%E7%90%86"><span class="toc-number">7.</span> <span class="toc-text">MySQL 管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">7.1.</span> <span class="toc-text">系统数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">7.2.</span> <span class="toc-text">常用工具</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Years Pass" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Years Pass</p><div class="description" itemprop="description">字节 + 编年史，记录开发旅程与项目成长。</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">6</span> <span class="name">posts</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2025/07/07/MySQL/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2025/07/26/csharp/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/2025/05/20/c++%E6%8F%90%E9%AB%98%E7%BC%96%E7%A8%8B/" title="C++提高编程">C++提高编程</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2025/07/26/csharp/" title="C Sharp">C Sharp</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2025/04/21/c++%E6%A0%B8%E5%BF%83%E7%BC%96%E7%A8%8B/" title="C++核心编程">C++核心编程</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2025/07/15/MySQL%E8%BF%9B%E9%98%B6/" title="MySQL进阶">MySQL进阶</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2025/02/02/c++/" title="C++基础入门">C++基础入门</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2025/07/07/MySQL/" title="MySQL基础">MySQL基础</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Years Pass @ ByteChronicle</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2025/07/15/MySQL进阶/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->